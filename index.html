<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartSpeak AI Tutor</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="SmartSpeak AI English Tutor - Learn English through natural conversation with AI">
  <meta name="theme-color" content="#66a6ff">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  <link rel="apple-touch-icon" href="/icon-192.png">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }
    body {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle at top left, #89f7fe, #66a6ff);
      background-attachment: fixed;
      overflow: hidden;
    }
    
    /* ============================================
       AUTH PAGES STYLES
       ============================================ */
    .auth-container {
      width: 95%;
      max-width: 400px;
      padding: 2rem;
      backdrop-filter: blur(15px);
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
    }
    .auth-container h2 {
      text-align: center;
      color: #333;
      margin-bottom: 1.5rem;
    }
    .auth-container input {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1rem;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
      transition: border 0.3s;
    }
    .auth-container input:focus {
      border-color: #66a6ff;
    }
    .auth-container button {
      width: 100%;
      padding: 0.8rem;
      background: #66a6ff;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      margin-bottom: 0.5rem;
    }
    .auth-container button:hover {
      background: #4b8efc;
    }
    .auth-link {
      text-align: center;
      margin-top: 1rem;
      color: #666;
    }
    .auth-link a {
      color: #66a6ff;
      text-decoration: none;
      font-weight: 600;
    }
    .auth-link a:hover {
      text-decoration: underline;
    }
    .forgot-password {
      text-align: right;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .forgot-password a {
      color: #66a6ff;
      text-decoration: none;
    }
    
    /* Auth Footer - Animated Developer Credit */
    .auth-footer {
      margin-top: 2rem;
      text-align: center;
      padding-top: 1rem;
      border-top: 1px solid rgba(0,0,0,0.1);
    }
    .auth-footer-text {
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      background: linear-gradient(
        90deg,
        #ff6b6b,
        #feca57,
        #48dbfb,
        #ff9ff3,
        #54a0ff,
        #5f27cd,
        #00d2d3,
        #ff6b6b
      );
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 5s ease infinite;
    }
    
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 0.8rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      text-align: center;
    }
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 0.8rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    /* OTP Input Styling */
    .otp-container {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .otp-container input {
      width: 50px;
      height: 50px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0;
    }
    
    /* ============================================
       MAIN APP LAYOUT
       ============================================ */
    .app-container {
      width: 100%;
      height: 100vh;
      display: flex;
    }
    
    /* ============================================
       SIDEBAR STYLES
       ============================================ */
    .sidebar {
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .user-profile {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      background: rgba(102,166,255,0.1);
    }
    .user-email {
      font-size: 0.9rem;
      color: #333;
      margin-bottom: 0.8rem;
      word-break: break-all;
    }
    .logout-btn {
      padding: 0.5rem 1rem;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      width: 100%;
    }
    .logout-btn:hover {
      background: #ee5a5a;
    }
    .conversations-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    .conversation-item {
      padding: 0.8rem;
      background: rgba(102,166,255,0.1);
      border-radius: 10px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .conversation-item:hover {
      background: rgba(102,166,255,0.2);
    }
    .conversation-item.active {
      background: rgba(102,166,255,0.3);
      border-left: 3px solid #66a6ff;
    }
    .conversation-title {
      font-size: 0.9rem;
      color: #333;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .conversation-date {
      font-size: 0.75rem;
      color: #999;
    }
    .delete-btn {
      background: none;
      border: none;
      color: #ff6b6b;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0 0.5rem;
    }
    .new-chat-btn {
      margin: 1rem;
      padding: 0.8rem;
      background: #66a6ff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    .new-chat-btn:hover {
      background: #4b8efc;
    }
    
    /* ============================================
       CHAT AREA STYLES
       ============================================ */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(15px);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .chat-header {
      padding: 1.2rem;
      text-align: center;
      background: rgba(255, 255, 255, 0.3);
      font-weight: 800;
      font-size: 1.4rem;
      color: #fff;
      letter-spacing: 1.5px;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.4);
    }
    
    .settings-panel {
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.25);
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }
    .setting-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .setting-group label {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .setting-group select,
    .setting-group input {
      padding: 0.4rem 0.6rem;
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.95);
      font-size: 0.85rem;
      outline: none;
      cursor: pointer;
    }
    .setting-group input[type="range"] {
      width: 100px;
    }
    
    .voice-controls {
      display: flex;
      gap: 0.5rem;
    }
    .voice-btn {
      padding: 0.3rem 0.8rem;
      border: none;
      border-radius: 8px;
      font-size: 0.75rem;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }
    .play-btn {
      background: #51cf66;
      color: white;
    }
    .play-btn:hover {
      background: #40c057;
    }
    .stop-btn {
      background: #ff6b6b;
      color: white;
    }
    .stop-btn:hover {
      background: #ee5a5a;
    }
    
    .chat-box {
      flex: 1;
      padding: 1rem;
      padding-bottom: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      scroll-behavior: smooth;
    }
    .bubble {
      padding: 0.75rem 1rem;
      border-radius: 15px;
      max-width: 80%;
      line-height: 1.4;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
    }
    .user {
      align-self: flex-end;
      background: rgba(102,166,255,0.9);
      color: #fff;
      border-bottom-right-radius: 2px;
    }
    .ai {
      align-self: flex-start;
      background: rgba(255,255,255,0.9);
      color: #333;
      border-bottom-left-radius: 2px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .typing {
      align-self: flex-start;
      background: rgba(255,255,255,0.85);
      padding: 1rem;
      border-radius: 15px;
      border-bottom-left-radius: 2px;
    }
    .typing-dots {
      display: flex;
      gap: 5px;
    }
    .typing-dots span {
      width: 8px;
      height: 8px;
      background: #666;
      border-radius: 50%;
      animation: bounce 1.4s infinite;
    }
    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    .listen-btn {
      display: inline-block;
      margin-top: 8px;
      background: rgba(102,166,255,0.15);
      color: #0072ff;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 12px;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: 0.2s;
      font-weight: 600;
    }
    .listen-btn:hover {
      background: rgba(102,166,255,0.3);
      transform: scale(1.05);
    }
    .listen-btn:active {
      transform: scale(0.95);
    }
    
    .chat-input {
      display: flex;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      gap: 0.5rem;
    }
    .chat-input input {
      flex: 1;
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 20px;
      outline: none;
      font-size: 1rem;
    }
    .chat-input button {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 20px;
      background: #66a6ff;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    .chat-input button:hover {
      background: #4b8efc;
    }
    .chat-input button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .mic-btn {
      background: #ff6b6b !important;
    }
    .mic-btn:hover {
      background: #ee5a5a !important;
    }
    .mic-btn.active {
      background: #51cf66 !important;
      animation: pulse 1s infinite;
    }
    
    /* ============================================
       CUSTOM MODAL
       ============================================ */
    .custom-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }
    .custom-modal.show {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      animation: fadeIn 0.3s;
    }
    .modal-content h3 {
      margin-bottom: 1rem;
      color: #333;
    }
    .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.5rem;
    }
    .modal-btn {
      padding: 0.6rem 1.5rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #333;
    }
    .modal-btn-cancel:hover {
      background: #d0d0d0;
    }
    .modal-btn-confirm {
      background: #ff6b6b;
      color: white;
    }
    .modal-btn-confirm:hover {
      background: #ee5a5a;
    }
    
    /* ============================================
       ANIMATIONS
       ============================================ */
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* ============================================
       MOBILE RESPONSIVE
       ============================================ */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        position: absolute;
        left: -100%;
        transition: left 0.3s;
        z-index: 100;
      }
      .sidebar.open {
        left: 0;
      }
      .app-container {
        flex-direction: column;
      }
      .chat-header {
        font-size: 1.1rem;
      }
      .settings-panel {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .setting-group {
        flex: 1;
        min-width: 70px;
      }
      .chat-box {
        padding-bottom: 15px;
      }
    }
    .menu-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 101;
      background: rgba(102,166,255,0.95);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    @media (max-width: 768px) {
      .menu-toggle {
        display: block;
      }
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  
  <!-- ============================================
       LOGIN PAGE
       ============================================ -->
  <div id="loginPage" class="auth-container">
    <h2>🧠 SmartSpeak Login</h2>
    <div id="loginMessage"></div>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <div class="forgot-password">
      <a href="#" onclick="showForgotPassword(); return false;">Forgot Password?</a>
    </div>
    <button onclick="login()">Login</button>
    <div class="auth-link">
      Don't have an account? <a href="#" onclick="showSignup(); return false;">Sign Up</a>
    </div>
    <div class="auth-footer">
      <div class="auth-footer-text">Developed by Heber Mayormita</div>
    </div>
  </div>

  <!-- ============================================
       SIGNUP PAGE
       ============================================ -->
  <div id="signupPage" class="auth-container hidden">
    <h2>🧠 Create Account</h2>
    <div id="signupMessage"></div>
    <input type="email" id="signupEmail" placeholder="Email" />
    <input type="password" id="signupPassword" placeholder="Password (min 6 characters)" />
    <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" />
    <button onclick="signup()">Sign Up</button>
    <div class="auth-link">
      Already have an account? <a href="#" onclick="showLogin(); return false;">Login</a>
    </div>
    <div class="auth-footer">
      <div class="auth-footer-text">Developed by Heber Mayormita</div>
    </div>
  </div>

  <!-- ============================================
       FORGOT PASSWORD PAGE - OTP SYSTEM
       ============================================ -->
  <div id="forgotPasswordPage" class="auth-container hidden">
    <h2>Reset Password</h2>
    <p style="text-align:center; margin-bottom:1rem; color:#666;">Enter your email to receive an OTP code</p>
    <div id="forgotMessage"></div>
    
    <!-- Step 1: Enter Email -->
    <div id="emailStep">
      <input type="email" id="resetEmail" placeholder="Your email" />
      <button onclick="sendOTP()">Send OTP</button>
    </div>
    
    <!-- Step 2: Enter OTP -->
    <div id="otpStep" class="hidden">
      <p style="text-align:center; margin-bottom:1rem; color:#666; font-size:0.9rem;">
        Enter the 6-digit code sent to your email
      </p>
      <div class="otp-container">
        <input type="text" maxlength="1" class="otp-input" id="otp1" />
        <input type="text" maxlength="1" class="otp-input" id="otp2" />
        <input type="text" maxlength="1" class="otp-input" id="otp3" />
        <input type="text" maxlength="1" class="otp-input" id="otp4" />
        <input type="text" maxlength="1" class="otp-input" id="otp5" />
        <input type="text" maxlength="1" class="otp-input" id="otp6" />
      </div>
      <button onclick="verifyOTP()">Verify OTP</button>
      <button onclick="resendOTP()" style="background:#6c757d; margin-top:0.5rem;">Resend OTP</button>
    </div>
    
    <!-- Step 3: Create New Password -->
    <div id="newPasswordStep" class="hidden">
      <p style="text-align:center; margin-bottom:1rem; color:#666;">Create your new password</p>
      <input type="password" id="newPassword" placeholder="New password (min 6 characters)" />
      <input type="password" id="confirmNewPassword" placeholder="Confirm new password" />
      <button onclick="resetPassword()">Reset Password</button>
    </div>
    
    <div class="auth-link">
      <a href="#" onclick="showLogin(); return false;">Back to Login</a>
    </div>
    <div class="auth-footer">
      <div class="auth-footer-text">Developed by Heber Mayormita</div>
    </div>
  </div>

  <!-- ============================================
       MAIN APP CONTAINER
       ============================================ -->
  <div id="appContainer" class="app-container hidden">
    
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="user-profile">
        <div class="user-email" id="userEmail"></div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
      
      <button class="new-chat-btn" onclick="startNewConversation()">+ New Conversation</button>
      
      <div class="conversations-list" id="conversationsList">
        <!-- Conversations loaded dynamically -->
      </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <div class="chat-header">🧠 SmartSpeak AI English Tutor</div>
      
      <div class="settings-panel">
        <div class="setting-group">
          <label>🌍 Accent</label>
          <select id="accentSelect" onchange="updateVoiceSettings()">
            <option value="en-US">🇺🇸 American</option>
            <option value="en-GB">🇬🇧 British</option>
            <option value="en-AU">🇦🇺 Australian</option>
            <option value="en-IN">🇮🇳 Indian</option>
            <option value="en-PH">🇵🇭 Filipino</option>
          </select>
        </div>
        
        <div class="setting-group">
          <label>👤 Voice</label>
          <select id="voiceGender" onchange="updateVoiceSettings()">
            <option value="female">👩 Female</option>
            <option value="male">👨 Male</option>
          </select>
        </div>
        
        <div class="setting-group">
          <label>⚡ Speed</label>
          <input type="range" id="speedControl" min="0.5" max="2" step="0.1" value="1">
        </div>
        
        <div class="setting-group">
          <label>🎵 Pitch</label>
          <input type="range" id="pitchControl" min="0.5" max="2" step="0.1" value="1">
        </div>
        
        <div class="setting-group">
          <label>🔊 Controls</label>
          <div class="voice-controls">
            <button class="voice-btn stop-btn" onclick="stopSpeaking()">⏹ Stop</button>
          </div>
        </div>
      </div>

      <div id="chatBox" class="chat-box"></div>
      
      <div class="chat-input">
        <input type="text" id="userInput" placeholder="Type your message..." />
        <button id="micBtn" class="mic-btn">🎤</button>
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- ============================================
       CUSTOM MODAL
       ============================================ -->
  <div id="customModal" class="custom-modal">
    <div class="modal-content">
      <h3 id="modalTitle">Confirm</h3>
      <p id="modalMessage"></p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal(false)">Cancel</button>
        <button class="modal-btn modal-btn-confirm" onclick="closeModal(true)">Delete</button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu Toggle -->
  <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://ceymeqjxsqrhcrxntrwh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNleW1lcWp4c3FyaGNyeG50cndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2Mzc4ODMsImV4cCI6MjA3NzIxMzg4M30.QKJRqrszrmlmX2wWvlNRofO8bd93mVBnRRYiPpcbkno';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ============================================
    // GLOBAL STATE
    // ============================================
    let currentUser = null;
    let currentConversationId = null;
    let conversationHistory = [];
    let recognition = null;
    let isListening = false;
    let modalCallback = null;
    let currentUtterance = null;
    let availableVoices = [];
    let selectedVoice = null;
    let otpToken = null; // Store OTP verification token
    let resetEmailAddress = null; // Store email for password reset

    // ============================================
    // VOICE & SPEECH FUNCTIONS - FIXED
    // ============================================
    
    // Load voices when available
    function loadVoices() {
      availableVoices = speechSynthesis.getVoices();
      if (availableVoices.length > 0) {
        updateVoiceSettings();
      }
    }
    
    // Load voices immediately and on change
    loadVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }
    
    /**
     * Update voice selection based on settings - FIXED
     */
    function updateVoiceSettings() {
      const accent = document.getElementById('accentSelect').value;
      const gender = document.getElementById('voiceGender').value;
      
      if (availableVoices.length === 0) {
        availableVoices = speechSynthesis.getVoices();
      }
      
      // Voice selection priority for each accent
      const voicePatterns = {
        'en-US': {
          female: ['Samantha', 'Victoria', 'Ava', 'Allison', 'Susan', 'Zira', 'female'],
          male: ['Alex', 'Tom', 'Daniel', 'Fred', 'David', 'Mark', 'male']
        },
        'en-GB': {
          female: ['Kate', 'Serena', 'Hazel', 'female'],
          male: ['Daniel', 'Oliver', 'George', 'male']
        },
        'en-AU': {
          female: ['Karen', 'Catherine', 'female'],
          male: ['Lee', 'male']
        },
        'en-IN': {
          female: ['Veena', 'Lekha', 'female'],
          male: ['Rishi', 'male']
        },
        'en-PH': {
          female: ['Samantha', 'Ava', 'female'],
          male: ['Alex', 'Tom', 'male']
        }
      };
      
      const patterns = voicePatterns[accent] || voicePatterns['en-US'];
      const genderPatterns = patterns[gender];
      
      // First try to find exact lang match with gender
      let voice = null;
      for (const pattern of genderPatterns) {
        voice = availableVoices.find(v => 
          v.lang.startsWith(accent.split('-')[0]) &&
          v.name.includes(pattern)
        );
        if (voice) break;
      }
      
      // If not found, try any voice with matching language
      if (!voice) {
        voice = availableVoices.find(v => v.lang === accent);
      }
      
      // Fallback to first voice with matching language prefix
      if (!voice) {
        voice = availableVoices.find(v => v.lang.startsWith(accent.split('-')[0]));
      }
      
      // Final fallback
      if (!voice && availableVoices.length > 0) {
        voice = availableVoices[0];
      }
      
      selectedVoice = voice;
      console.log('Selected voice:', voice?.name, voice?.lang);
    }
    
    /**
     * Speak text with current settings - FIXED
     */
    function speakText(text) {
      // Stop any ongoing speech
      stopSpeaking();
      
      // Small delay to ensure previous speech is stopped
      setTimeout(() => {
        const utterance = new SpeechSynthesisUtterance(text);
        
        // Apply selected voice
        if (selectedVoice) {
          utterance.voice = selectedVoice;
          utterance.lang = selectedVoice.lang;
        } else {
          utterance.lang = document.getElementById('accentSelect').value;
        }
        
        utterance.rate = parseFloat(document.getElementById('speedControl').value);
        utterance.pitch = parseFloat(document.getElementById('pitchControl').value);
        
        // Track current utterance
        currentUtterance = utterance;
        
        // Clear tracking when done
        utterance.onend = () => {
          currentUtterance = null;
        };
        
        utterance.onerror = (event) => {
          console.error('Speech error:', event);
          currentUtterance = null;
        };
        
        speechSynthesis.speak(utterance);
      }, 100);
    }
    
    /**
     * Stop current speech - FIXED
     */
    function stopSpeaking() {
      if (speechSynthesis.speaking || speechSynthesis.pending) {
        speechSynthesis.cancel();
      }
      currentUtterance = null;
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================
    
    function showConfirmModal(message, callback) {
      document.getElementById('modalMessage').textContent = message;
      document.getElementById('customModal').classList.add('show');
      modalCallback = callback;
    }

    function closeModal(confirmed) {
      document.getElementById('customModal').classList.remove('show');
      if (modalCallback) {
        modalCallback(confirmed);
        modalCallback = null;
      }
    }

    // ============================================
    // OTP INPUT HANDLING
    // ============================================
    
    // Auto-focus next OTP input
    document.addEventListener('DOMContentLoaded', () => {
      const otpInputs = document.querySelectorAll('.otp-input');
      otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          if (e.target.value.length === 1 && index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
        });
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            otpInputs[index - 1].focus();
          }
        });
      });
    });

    // ============================================
    // AUTHENTICATION FUNCTIONS
    // ============================================
    
    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        currentUser = user;
        showApp();
        loadConversations();
      } else {
        showLogin();
      }
    }

    async function login() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!email || !password) {
        showMessage('loginMessage', 'Please enter email and password', 'error');
        return;
      }
      
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });
      
      if (error) {
        showMessage('loginMessage', error.message, 'error');
      } else {
        currentUser = data.user;
        showApp();
        loadConversations();
      }
    }

    async function signup() {
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('signupConfirmPassword').value;
      
      if (!email || !password || !confirmPassword) {
        showMessage('signupMessage', 'Please fill all fields', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        showMessage('signupMessage', 'Passwords do not match', 'error');
        return;
      }
      
      if (password.length < 6) {
        showMessage('signupMessage', 'Password must be at least 6 characters', 'error');
        return;
      }
      
      const { data, error } = await supabase.auth.signUp({
        email,
        password
      });
      
      if (error) {
        showMessage('signupMessage', error.message, 'error');
      } else {
        showMessage('signupMessage', '✅ Account created! You can now login.', 'success');
        setTimeout(() => showLogin(), 2000);
      }
    }

    // ============================================
    // OTP PASSWORD RESET SYSTEM
    // ============================================
    
    async function sendOTP() {
      const email = document.getElementById('resetEmail').value.trim();
      
      if (!email) {
        showMessage('forgotMessage', 'Please enter your email', 'error');
        return;
      }
      
      resetEmailAddress = email;
      
      // Generate 6-digit OTP
      const otp = Math.floor(100000 + Math.random() * 900000).toString();
      
      // Send OTP via Supabase Auth (using password reset with OTP in email)
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin
      });
      
      if (error) {
        showMessage('forgotMessage', error.message, 'error');
        return;
      }
      
      // Store OTP token (in production, this should be server-side)
      otpToken = otp;
      
      // Show OTP step
      document.getElementById('emailStep').classList.add('hidden');
      document.getElementById('otpStep').classList.remove('hidden');
      showMessage('forgotMessage', `✅ OTP sent to ${email}. Check your email!`, 'success');
      
      // For demo purposes, also log OTP (remove in production)
      console.log('OTP Code:', otp);
      showMessage('forgotMessage', `✅ OTP sent! (Demo: ${otp})`, 'success');
    }
    
    function getOTPValue() {
      let otp = '';
      for (let i = 1; i <= 6; i++) {
        otp += document.getElementById(`otp${i}`).value;
      }
      return otp;
    }
    
    async function verifyOTP() {
      const enteredOTP = getOTPValue();
      
      if (enteredOTP.length !== 6) {
        showMessage('forgotMessage', 'Please enter complete 6-digit OTP', 'error');
        return;
      }
      
      // Verify OTP (in production, verify with backend)
      if (enteredOTP === otpToken) {
        // OTP verified, show password reset form
        document.getElementById('otpStep').classList.add('hidden');
        document.getElementById('newPasswordStep').classList.remove('hidden');
        showMessage('forgotMessage', '✅ OTP verified! Create your new password.', 'success');
      } else {
        showMessage('forgotMessage', '❌ Invalid OTP. Please try again.', 'error');
      }
    }
    
    async function resendOTP() {
      if (!resetEmailAddress) {
        showMessage('forgotMessage', 'Please enter your email first', 'error');
        return;
      }
      
      // Clear previous OTP inputs
      for (let i = 1; i <= 6; i++) {
        document.getElementById(`otp${i}`).value = '';
      }
      
      await sendOTP();
    }
    
    async function resetPassword() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmNewPassword').value;
      
      if (!newPassword || !confirmPassword) {
        showMessage('forgotMessage', 'Please fill all fields', 'error');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showMessage('forgotMessage', 'Passwords do not match', 'error');
        return;
      }
      
      if (newPassword.length < 6) {
        showMessage('forgotMessage', 'Password must be at least 6 characters', 'error');
        return;
      }
      
      // In production, this would update password via backend
      // For now, we'll use Supabase's update password
      const { error } = await supabase.auth.updateUser({
        password: newPassword
      });
      
      if (error) {
        showMessage('forgotMessage', error.message, 'error');
      } else {
        showMessage('forgotMessage', '✅ Password reset successful! You can now login.', 'success');
        setTimeout(() => {
          showLogin();
          // Reset form
          document.getElementById('emailStep').classList.remove('hidden');
          document.getElementById('otpStep').classList.add('hidden');
          document.getElementById('newPasswordStep').classList.add('hidden');
          document.getElementById('resetEmail').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmNewPassword').value = '';
          for (let i = 1; i <= 6; i++) {
            document.getElementById(`otp${i}`).value = '';
          }
          otpToken = null;
          resetEmailAddress = null;
        }, 2000);
      }
    }

    async function logout() {
      await supabase.auth.signOut();
      currentUser = null;
      currentConversationId = null;
      conversationHistory = [];
      document.getElementById('chatBox').innerHTML = '';
      showLogin();
    }

    // ============================================
    // UI NAVIGATION
    // ============================================
    
    function showLogin() {
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('signupPage').classList.add('hidden');
      document.getElementById('forgotPasswordPage').classList.add('hidden');
      document.getElementById('appContainer').classList.add('hidden');
    }

    function showSignup() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('signupPage').classList.remove('hidden');
      document.getElementById('forgotPasswordPage').classList.add('hidden');
      document.getElementById('appContainer').classList.add('hidden');
    }

    function showForgotPassword() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('signupPage').classList.add('hidden');
      document.getElementById('forgotPasswordPage').classList.remove('hidden');
      document.getElementById('appContainer').classList.add('hidden');
      
      // Reset form to email step
      document.getElementById('emailStep').classList.remove('hidden');
      document.getElementById('otpStep').classList.add('hidden');
      document.getElementById('newPasswordStep').classList.add('hidden');
    }

    function showApp() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('signupPage').classList.add('hidden');
      document.getElementById('forgotPasswordPage').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('hidden');
      document.getElementById('userEmail').textContent = currentUser.email;
    }

    function showMessage(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="${type}-message">${message}</div>`;
      setTimeout(() => el.innerHTML = '', 5000);
    }

    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
    }

    // ============================================
    // CONVERSATION MANAGEMENT
    // ============================================
    
    async function loadConversations() {
      const { data, error } = await supabase
        .from('conversations')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('updated_at', { ascending: false });
      
      if (error) {
        console.error('Error loading conversations:', error);
        return;
      }
      
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';
      
      if (data.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#999; padding:1rem;">No conversations yet</p>';
        return;
      }
      
      data.forEach(conv => {
        const div = document.createElement('div');
        div.className = 'conversation-item';
        if (conv.id === currentConversationId) {
          div.classList.add('active');
        }
        div.innerHTML = `
          <div>
            <div class="conversation-title">${conv.title}</div>
            <div class="conversation-date">${new Date(conv.created_at).toLocaleDateString()}</div>
          </div>
          <button class="delete-btn" onclick="confirmDeleteConversation('${conv.id}'); event.stopPropagation();">×</button>
        `;
        div.onclick = () => loadConversation(conv.id);
        list.appendChild(div);
      });
    }

    async function startNewConversation() {
      const { data, error } = await supabase
        .from('conversations')
        .insert([{
          user_id: currentUser.id,
          title: 'New Conversation'
        }])
        .select()
        .single();
      
      if (error) {
        console.error('Error creating conversation:', error);
        return;
      }
      
      currentConversationId = data.id;
      conversationHistory = [];
      document.getElementById('chatBox').innerHTML = '';
      
      // Re-enable controls
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('userInput').disabled = false;
      document.getElementById('userInput').focus();
      
      loadConversations();
      showWelcomeMessage();
    }

    async function loadConversation(conversationId) {
      currentConversationId = conversationId;
      
      const { data, error } = await supabase
        .from('messages')
        .select('*')
        .eq('conversation_id', conversationId)
        .order('created_at', { ascending: true });
      
      if (error) {
        console.error('Error loading messages:', error);
        return;
      }
      
      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML = '';
      
      conversationHistory = data.map(msg => ({
        role: msg.role,
        content: msg.content
      }));
      
      data.forEach(msg => {
        const bubble = document.createElement('div');
        bubble.className = `bubble ${msg.role}`;
        const escapedContent = msg.content.replace(/`/g, '\\`').replace(/'/g, "\\'");
        bubble.innerHTML = `
          ${msg.content.replace(/\n/g, '<br>')}
          ${msg.role === 'assistant' ? `<button class="listen-btn" onclick="speakText(\`${escapedContent}\`)">🎧 Listen</button>` : ''}
        `;
        chatBox.appendChild(bubble);
      });
      
      chatBox.scrollTop = chatBox.scrollHeight;
      
      // Re-enable controls
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('userInput').disabled = false;
      document.getElementById('userInput').focus();
      
      loadConversations();
    }

    function confirmDeleteConversation(conversationId) {
      showConfirmModal('Do you want to delete this conversation?', (confirmed) => {
        if (confirmed) {
          deleteConversation(conversationId);
        }
      });
    }

    async function deleteConversation(conversationId) {
      const { error } = await supabase
        .from('conversations')
        .delete()
        .eq('id', conversationId);
      
      if (error) {
        console.error('Error deleting conversation:', error);
        return;
      }
      
      if (conversationId === currentConversationId) {
        currentConversationId = null;
        conversationHistory = [];
        document.getElementById('chatBox').innerHTML = '';
      }
      
      loadConversations();
    }

    async function saveMessage(role, content) {
      if (!currentConversationId) {
        await startNewConversation();
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      const { error } = await supabase
        .from('messages')
        .insert([{
          conversation_id: currentConversationId,
          role: role,
          content: content
        }]);
      
      if (error) {
        console.error('Error saving message:', error);
      }
      
      if (role === 'user' && conversationHistory.filter(m => m.role === 'user').length === 1) {
        const title = content.slice(0, 50) + (content.length > 50 ? '...' : '');
        await supabase
          .from('conversations')
          .update({ 
            title: title,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentConversationId);
      } else {
        await supabase
          .from('conversations')
          .update({ updated_at: new Date().toISOString() })
          .eq('id', currentConversationId);
      }
      
      loadConversations();
    }
    
    // ============================================
    // CHAT FUNCTIONALITY
    // ============================================
    
    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');

    // Initialize Speech Recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'en-US';
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
      };
      
      recognition.onend = () => {
        isListening = false;
        micBtn.classList.remove('active');
        micBtn.textContent = '🎤';
      };
      
      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        isListening = false;
        micBtn.classList.remove('active');
        micBtn.textContent = '🎤';
      };
    }

    micBtn.addEventListener('click', () => {
      if (!recognition) {
        alert('Speech recognition is not supported in your browser.');
        return;
      }
      
      if (isListening) {
        recognition.stop();
      } else {
        try {
          recognition.start();
          isListening = true;
          micBtn.classList.add('active');
          micBtn.textContent = '🔴';
        } catch (err) {
          console.error('Recognition start error:', err);
        }
      }
    });

    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
      chatBox.appendChild(typingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function hideTypingIndicator() {
      const typingDiv = document.getElementById('typing-indicator');
      if (typingDiv) typingDiv.remove();
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      if (!currentConversationId) {
        await startNewConversation();
      }

      sendBtn.disabled = true;
      userInput.disabled = true;

      const userBubble = document.createElement('div');
      userBubble.className = 'bubble user';
      userBubble.textContent = message;
      chatBox.appendChild(userBubble);
      
      // Smooth scroll to bottom
      setTimeout(() => {
        chatBox.scrollTop = chatBox.scrollHeight;
      }, 100);
      
      conversationHistory.push({ role: "user", content: message });
      await saveMessage("user", message);
      
      userInput.value = "";
      showTypingIndicator();

      try {
        const res = await fetch('/api/ask-ai', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            message: message,
            history: conversationHistory.slice(-10)
          }),
        });

        if (!res.ok) {
          throw new Error(`Server error: ${res.status}`);
        }

        const data = await res.json();
        hideTypingIndicator();
        
        if (data.error) {
          throw new Error(data.error);
        }

        const aiReply = data.reply || "I apologize, but I couldn't generate a response. Please try again.";
        conversationHistory.push({ role: "assistant", content: aiReply });
        await saveMessage("assistant", aiReply);

        const aiBubble = document.createElement("div");
        aiBubble.className = "bubble ai";
        const escapedReply = aiReply.replace(/`/g, '\\`').replace(/'/g, "\\'");
        aiBubble.innerHTML = `
          ${aiReply.replace(/\n/g, '<br>')}
          <button class="listen-btn" onclick="speakText(\`${escapedReply}\`)">🎧 Listen</button>
        `;
        chatBox.appendChild(aiBubble);
        
        // Smooth scroll to bottom after AI reply
        setTimeout(() => {
          chatBox.scrollTop = chatBox.scrollHeight;
        }, 100);
        
        // Auto-play response
        speakText(aiReply);

      } catch (error) {
        hideTypingIndicator();
        console.error('Error:', error);
        
        const errorBubble = document.createElement("div");
        errorBubble.className = "bubble ai";
        errorBubble.innerHTML = `
          ❌ Sorry, I'm having trouble connecting. Please check your internet and try again.
        `;
        chatBox.appendChild(errorBubble);
        
        // Scroll to error message
        setTimeout(() => {
          chatBox.scrollTop = chatBox.scrollHeight;
        }, 100);
      } finally {
        sendBtn.disabled = false;
        userInput.disabled = false;
        userInput.focus();
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !sendBtn.disabled) sendMessage();
    });

    function showWelcomeMessage() {
      const welcomeMsg = "Hello! I'm SmartSpeak, your AI English tutor. I'm here to help you improve your English skills through natural conversation. Feel free to ask me questions, practice speaking, or discuss any topic you'd like. How can I help you today?";
      conversationHistory.push({ role: "assistant", content: welcomeMsg });
      
      const aiBubble = document.createElement("div");
      aiBubble.className = "bubble ai";
      const escapedMsg = welcomeMsg.replace(/`/g, '\\`').replace(/'/g, "\\'");
      aiBubble.innerHTML = `
        ${welcomeMsg}
        <button class="listen-btn" onclick="speakText(\`${escapedMsg}\`)">🎧 Listen</button>
      `;
      chatBox.appendChild(aiBubble);
      speakText(welcomeMsg);
    }

    // ============================================
    // GLOBAL FUNCTION EXPORTS
    // ============================================
    window.speakText = speakText;
    window.stopSpeaking = stopSpeaking;
    window.updateVoiceSettings = updateVoiceSettings;
    window.startNewConversation = startNewConversation;
    window.loadConversation = loadConversation;
    window.confirmDeleteConversation = confirmDeleteConversation;
    window.deleteConversation = deleteConversation;
    window.toggleSidebar = toggleSidebar;
    window.showConfirmModal = showConfirmModal;
    window.closeModal = closeModal;
    window.sendOTP = sendOTP;
    window.verifyOTP = verifyOTP;
    window.resendOTP = resendOTP;
    window.resetPassword = resetPassword;
    
    // ============================================
    // INITIALIZATION
    // ============================================
    checkAuth();
  </script>
  
  <!-- ============================================
       PWA SERVICE WORKER
       ============================================ -->
  <script>
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('PWA installable');
    });
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>
