<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartSpeak AI Tutor</title>
<!-- PWA Meta Tags -->
  <meta name="description" content="SmartSpeak AI English Tutor - Learn English through natural conversation with AI">
  <meta name="theme-color" content="#66a6ff">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }
    body {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle at top left, #89f7fe, #66a6ff);
      background-attachment: fixed;
      overflow: hidden;
    }
    
    /* Auth Pages Styles */
    .auth-container {
      width: 95%;
      max-width: 400px;
      padding: 2rem;
      backdrop-filter: blur(15px);
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
    }
    .auth-container h2 {
      text-align: center;
      color: #333;
      margin-bottom: 1.5rem;
    }
    .auth-container input {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1rem;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
      transition: border 0.3s;
    }
    .auth-container input:focus {
      border-color: #66a6ff;
    }
    .auth-container button {
      width: 100%;
      padding: 0.8rem;
      background: #66a6ff;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      margin-bottom: 0.5rem;
    }
    .auth-container button:hover {
      background: #4b8efc;
    }
    .auth-link {
      text-align: center;
      margin-top: 1rem;
      color: #666;
    }
    .auth-link a {
      color: #66a6ff;
      text-decoration: none;
      font-weight: 600;
    }
    .auth-link a:hover {
      text-decoration: underline;
    }
    .forgot-password {
      text-align: right;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .forgot-password a {
      color: #66a6ff;
      text-decoration: none;
    }
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 0.8rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      text-align: center;
    }
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 0.8rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    /* Chat Container Styles */
    .app-container {
      width: 100%;
      height: 100vh;
      display: flex;
    }
    .sidebar {
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .user-profile {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      background: rgba(102,166,255,0.1);
    }
    .user-email {
      font-size: 0.9rem;
      color: #333;
      margin-bottom: 0.8rem;
      word-break: break-all;
    }
    .logout-btn {
      padding: 0.5rem 1rem;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      width: 100%;
    }
    .logout-btn:hover {
      background: #ee5a5a;
    }
    .conversations-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    .conversation-item {
      padding: 0.8rem;
      background: rgba(102,166,255,0.1);
      border-radius: 10px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .conversation-item:hover {
      background: rgba(102,166,255,0.2);
    }
    .conversation-item.active {
      background: rgba(102,166,255,0.3);
      border-left: 3px solid #66a6ff;
    }
    .conversation-title {
      font-size: 0.9rem;
      color: #333;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .conversation-date {
      font-size: 0.75rem;
      color: #999;
    }
    .delete-btn {
      background: none;
      border: none;
      color: #ff6b6b;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0 0.5rem;
    }
    .new-chat-btn {
      margin: 1rem;
      padding: 0.8rem;
      background: #66a6ff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    .new-chat-btn:hover {
      background: #4b8efc;
    }
    
    /* Chat Area */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(15px);
      background: rgba(255, 255, 255, 0.15);
    }
    .chat-header {
      padding: 1rem;
      text-align: center;
      background: rgba(255, 255, 255, 0.25);
      font-weight: 700;
      color: #fff;
      letter-spacing: 1px;
      text-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    .settings-panel {
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }
    .setting-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .setting-group label {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .setting-group select,
    .setting-group input {
      padding: 0.4rem 0.6rem;
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.9);
      font-size: 0.85rem;
      outline: none;
      cursor: pointer;
    }
    .setting-group input[type="range"] {
      width: 100px;
    }
    .chat-box {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .bubble {
      padding: 0.75rem 1rem;
      border-radius: 15px;
      max-width: 80%;
      line-height: 1.4;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
    }
    .user {
      align-self: flex-end;
      background: rgba(102,166,255,0.9);
      color: #fff;
      border-bottom-right-radius: 2px;
    }
    .ai {
      align-self: flex-start;
      background: rgba(255,255,255,0.85);
      color: #333;
      border-bottom-left-radius: 2px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .typing {
      align-self: flex-start;
      background: rgba(255,255,255,0.85);
      padding: 1rem;
      border-radius: 15px;
      border-bottom-left-radius: 2px;
    }
    .typing-dots {
      display: flex;
      gap: 5px;
    }
    .typing-dots span {
      width: 8px;
      height: 8px;
      background: #666;
      border-radius: 50%;
      animation: bounce 1.4s infinite;
    }
    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    .listen-btn {
      display: block;
      margin-top: 6px;
      background: rgba(102,166,255,0.1);
      color: #0072ff;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 12px;
      padding: 4px 10px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: 0.2s;
    }
    .listen-btn:hover {
      background: rgba(102,166,255,0.25);
      transform: scale(1.05);
    }
    .chat-input {
      display: flex;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      gap: 0.5rem;
    }
    .chat-input input {
      flex: 1;
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 20px;
      outline: none;
      font-size: 1rem;
    }
    .chat-input button {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 20px;
      background: #66a6ff;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    .chat-input button:hover {
      background: #4b8efc;
    }
    .chat-input button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .mic-btn {
      background: #ff6b6b !important;
    }
    .mic-btn:hover {
      background: #ee5a5a !important;
    }
    .mic-btn.active {
      background: #51cf66 !important;
      animation: pulse 1s infinite;
    }
    
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
    
    .hidden {
      display: none !important;
    }
 /* Footer Styles */
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 0.5rem;
      text-align: center;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      font-size: 0.85rem;
      z-index: 1000;
    }
    .footer-text {
      background: linear-gradient(
        90deg,
        #ff6b6b,
        #feca57,
        #48dbfb,
        #ff9ff3,
        #54a0ff,
        #5f27cd,
        #00d2d3,
        #ff6b6b
      );
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 5s ease infinite;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        position: absolute;
        left: -100%;
        transition: left 0.3s;
        z-index: 100;
      }
      .sidebar.open {
        left: 0;
      }
      .app-container {
        flex-direction: column;
      }
      .chat-container {
        padding-bottom: 2.5rem;
      }
      .settings-panel {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .setting-group {
        flex: 1;
        min-width: 80px;
      }
      .footer {
        font-size: 0.75rem;
        padding: 0.4rem;
      }
    }
    .menu-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 101;
      background: rgba(102,166,255,0.9);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-size: 1.2rem;
    }
    @media (max-width: 768px) {
      .menu-toggle {
        display: block;
      }
    }
  </style>
</head>
<body>
  
  <!-- Login Page -->
  <div id="loginPage" class="auth-container">
    <h2>üß† SmartSpeak Login</h2>
    <div id="loginMessage"></div>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <div class="forgot-password">
      <a href="#" onclick="showForgotPassword(); return false;">Forgot Password?</a>
    </div>
    <button onclick="login()">Login</button>
    <div class="auth-link">
      Don't have an account? <a href="#" onclick="showSignup(); return false;">Sign Up</a>
    </div>
  </div>

  <!-- Signup Page -->
  <div id="signupPage" class="auth-container hidden">
    <h2>üß† Create Account</h2>
    <div id="signupMessage"></div>
    <input type="email" id="signupEmail" placeholder="Email" />
    <input type="password" id="signupPassword" placeholder="Password (min 6 characters)" />
    <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" />
    <button onclick="signup()">Sign Up</button>
    <div class="auth-link">
      Already have an account? <a href="#" onclick="showLogin(); return false;">Login</a>
    </div>
  </div>

  <!-- Forgot Password Page -->
  <div id="forgotPasswordPage" class="auth-container hidden">
    <h2>Reset Password</h2>
    <p style="text-align:center; margin-bottom:1rem; color:#666;">Enter your email and we'll send you a reset link</p>
    <div id="forgotMessage"></div>
    <input type="email" id="resetEmail" placeholder="Your email" />
    <button onclick="sendResetEmail()">Send Reset Link</button>
    <div class="auth-link">
      <a href="#" onclick="showLogin(); return false;">Back to Login</a>
    </div>
  </div>

  <!-- Main App Container -->
  <div id="appContainer" class="app-container hidden">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="user-profile">
        <div class="user-email" id="userEmail"></div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
      
      <button class="new-chat-btn" onclick="startNewConversation()">+ New Conversation</button>
      
      <div class="conversations-list" id="conversationsList">
        <!-- Conversations will be loaded here -->
      </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <div class="chat-header">üß† SmartSpeak AI English Tutor</div>
      
      <div class="settings-panel">
        <div class="setting-group">
          <label>üåç Accent</label>
          <select id="accentSelect">
            <option value="en-US">üá∫üá∏ American</option>
            <option value="en-GB">üá¨üáß British</option>
            <option value="en-AU">üá¶üá∫ Australian</option>
            <option value="en-IN">üáÆüá≥ Indian</option>
            <option value="en-PH" selected>üáµüá≠ Filipino</option>
          </select>
        </div>
        
        <div class="setting-group">
          <label>‚ö° Speed</label>
          <input type="range" id="speedControl" min="0.5" max="2" step="0.1" value="1">
        </div>
        
        <div class="setting-group">
          <label>üéµ Pitch</label>
          <input type="range" id="pitchControl" min="0.5" max="2" step="0.1" value="1">
        </div>
      </div>

      <div id="chatBox" class="chat-box"></div>
      
      <div class="chat-input">
        <input type="text" id="userInput" placeholder="Type your message..." />
        <button id="micBtn" class="mic-btn">üé§</button>
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // SUPABASE CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://ceymeqjxsqrhcrxntrwh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNleW1lcWp4c3FyaGNyeG50cndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2Mzc4ODMsImV4cCI6MjA3NzIxMzg4M30.QKJRqrszrmlmX2wWvlNRofO8bd93mVBnRRYiPpcbkno';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ============================================
    // GLOBAL VARIABLES
    // ============================================
    let currentUser = null;
    let currentConversationId = null;
    let conversationHistory = [];
    let recognition;
    let isListening = false;

    // ============================================
    // AUTHENTICATION FUNCTIONS
    // ============================================
    
    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        currentUser = user;
        showApp();
        loadConversations();
      } else {
        showLogin();
      }
    }

    async function login() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!email || !password) {
        showMessage('loginMessage', 'Please enter email and password', 'error');
        return;
      }
      
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });
      
      if (error) {
        showMessage('loginMessage', error.message, 'error');
      } else {
        currentUser = data.user;
        showApp();
        loadConversations();
      }
    }

    async function signup() {
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('signupConfirmPassword').value;
      
      if (!email || !password || !confirmPassword) {
        showMessage('signupMessage', 'Please fill all fields', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        showMessage('signupMessage', 'Passwords do not match', 'error');
        return;
      }
      
      if (password.length < 6) {
        showMessage('signupMessage', 'Password must be at least 6 characters', 'error');
        return;
      }
      
      const { data, error } = await supabase.auth.signUp({
        email,
        password
      });
      
      if (error) {
        showMessage('signupMessage', error.message, 'error');
      } else {
        showMessage('signupMessage', '‚úÖ Account created! You can now login.', 'success');
        setTimeout(() => showLogin(), 2000);
      }
    }

    async function sendResetEmail() {
      const email = document.getElementById('resetEmail').value.trim();
      
      if (!email) {
        showMessage('forgotMessage', 'Please enter your email', 'error');
        return;
      }
      
      const { error } = await supabase.auth.resetPasswordForEmail(email);
      
      if (error) {
        showMessage('forgotMessage', error.message, 'error');
      } else {
        showMessage('forgotMessage', '‚úÖ Password reset link sent! Check your email.', 'success');
        setTimeout(() => showLogin(), 3000);
      }
    }

    async function logout() {
      await supabase.auth.signOut();
      currentUser = null;
      currentConversationId = null;
      conversationHistory = [];
      document.getElementById('chatBox').innerHTML = '';
      showLogin();
    }

    // ============================================
    // UI NAVIGATION FUNCTIONS
    // ============================================
    
    function showLogin() {
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('signupPage').classList.add('hidden');
      document.getElementById('forgotPasswordPage').classList.add('hidden');
      document.getElementById('appContainer').classList.add('hidden');
    }

    function showSignup() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('signupPage').classList.remove('hidden');
      document.getElementById('forgotPasswordPage').classList.add('hidden');
      document.getElementById('appContainer').classList.add('hidden');
    }

    function showForgotPassword() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('signupPage').classList.add('hidden');
      document.getElementById('forgotPasswordPage').classList.remove('hidden');
      document.getElementById('appContainer').classList.add('hidden');
    }

    function showApp() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('signupPage').classList.add('hidden');
      document.getElementById('forgotPasswordPage').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('hidden');
      document.getElementById('userEmail').textContent = currentUser.email;
    }

    function showMessage(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="${type}-message">${message}</div>`;
      setTimeout(() => el.innerHTML = '', 5000);
    }

    // ============================================
    // CONVERSATION MANAGEMENT
    // ============================================
    
    async function loadConversations() {
      const { data, error } = await supabase
        .from('conversations')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('updated_at', { ascending: false });
      
      if (error) {
        console.error('Error loading conversations:', error);
        return;
      }
      
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';
      
      if (data.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#999; padding:1rem;">No conversations yet</p>';
        return;
      }
      
      data.forEach(conv => {
        const div = document.createElement('div');
        div.className = 'conversation-item';
        if (conv.id === currentConversationId) {
          div.classList.add('active');
        }
        div.innerHTML = `
          <div>
            <div class="conversation-title">${conv.title}</div>
            <div class="conversation-date">${new Date(conv.created_at).toLocaleDateString()}</div>
          </div>
          <button class="delete-btn" onclick="deleteConversation('${conv.id}'); event.stopPropagation();">√ó</button>
        `;
        div.onclick = () => loadConversation(conv.id);
        list.appendChild(div);
      });
    }

    async function startNewConversation() {
      const { data, error } = await supabase
        .from('conversations')
        .insert([{
          user_id: currentUser.id,
          title: 'New Conversation'
        }])
        .select()
        .single();
      
      if (error) {
        console.error('Error creating conversation:', error);
        alert('Error creating new conversation');
        return;
      }
      
      currentConversationId = data.id;
      conversationHistory = [];
      document.getElementById('chatBox').innerHTML = '';
      loadConversations();
      showWelcomeMessage();
    }

    async function loadConversation(conversationId) {
      currentConversationId = conversationId;
      
      const { data, error } = await supabase
        .from('messages')
        .select('*')
        .eq('conversation_id', conversationId)
        .order('created_at', { ascending: true });
      
      if (error) {
        console.error('Error loading messages:', error);
        return;
      }
      
      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML = '';
      
      conversationHistory = data.map(msg => ({
        role: msg.role,
        content: msg.content
      }));
      
      data.forEach(msg => {
        const bubble = document.createElement('div');
        bubble.className = `bubble ${msg.role}`;
        bubble.innerHTML = `
          ${msg.content.replace(/\n/g, '<br>')}
          ${msg.role === 'assistant' ? `<button class="listen-btn" onclick="speakText(\`${msg.content.replace(/`/g, '\\`')}\`)">üéß Listen Again</button>` : ''}
        `;
        chatBox.appendChild(bubble);
      });
      
      chatBox.scrollTop = chatBox.scrollHeight;
      loadConversations();
    }

    async function deleteConversation(conversationId) {
      if (!confirm('Delete this conversation?')) return;
      
      const { error } = await supabase
        .from('conversations')
        .delete()
        .eq('id', conversationId);
      
      if (error) {
        console.error('Error deleting conversation:', error);
        alert('Error deleting conversation');
        return;
      }
      
      if (conversationId === currentConversationId) {
        currentConversationId = null;
        conversationHistory = [];
        document.getElementById('chatBox').innerHTML = '';
      }
      
      loadConversations();
    }

    async function saveMessage(role, content) {
      if (!currentConversationId) {
        await startNewConversation();
      }
      
      const { error } = await supabase
        .from('messages')
        .insert([{
          conversation_id: currentConversationId,
          role: role,
          content: content
        }]);
      
      if (error) {
        console.error('Error saving message:', error);
      }
      
      if (role === 'user' && conversationHistory.filter(m => m.role === 'user').length === 1) {
        const title = content.slice(0, 50) + (content.length > 50 ? '...' : '');
        await supabase
          .from('conversations')
          .update({ 
            title: title,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentConversationId);
      } else {
        await supabase
          .from('conversations')
          .update({ updated_at: new Date().toISOString() })
          .eq('id', currentConversationId);
      }
      
      loadConversations();
    }

    // ============================================
    // CHAT FUNCTIONALITY
    // ============================================
    
    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const accentSelect = document.getElementById("accentSelect");
    const speedControl = document.getElementById("speedControl");
    const pitchControl = document.getElementById("pitchControl");

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'en-US';
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
      };
      
      recognition.onend = () => {
        isListening = false;
        micBtn.classList.remove('active');
        micBtn.textContent = 'üé§';
      };
      
      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        isListening = false;
        micBtn.classList.remove('active');
        micBtn.textContent = 'üé§';
      };
    }

    micBtn.addEventListener('click', () => {
      if (!recognition) {
        alert('Speech recognition is not supported in your browser.');
        return;
      }
      
      if (isListening) {
        recognition.stop();
      } else {
        try {
          recognition.start();
          isListening = true;
          micBtn.classList.add('active');
          micBtn.textContent = 'üî¥';
        } catch (err) {
          console.error('Recognition start error:', err);
        }
      }
    });

    function speakText(text) {
      speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = accentSelect.value;
      utter.rate = parseFloat(speedControl.value);
      utter.pitch = parseFloat(pitchControl.value);
      speechSynthesis.speak(utter);
    }

    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
      chatBox.appendChild(typingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function hideTypingIndicator() {
      const typingDiv = document.getElementById('typing-indicator');
      if (typingDiv) typingDiv.remove();
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      if (!currentConversationId) {
        await startNewConversation();
      }

      sendBtn.disabled = true;
      userInput.disabled = true;

      const userBubble = document.createElement('div');
      userBubble.className = 'bubble user';
      user
      userBubble.textContent = message;
      chatBox.appendChild(userBubble);
      chatBox.scrollTop = chatBox.scrollHeight;
      
      conversationHistory.push({ role: "user", content: message });
      await saveMessage("user", message);
      
      userInput.value = "";
      showTypingIndicator();

      try {
        const res = await fetch('/.netlify/functions/ask-ai', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            message: message,
            history: conversationHistory.slice(-10)
          }),
        });

        if (!res.ok) {
          throw new Error(`Server error: ${res.status}`);
        }

        const data = await res.json();
        hideTypingIndicator();
        
        if (data.error) {
          throw new Error(data.error);
        }

        const aiReply = data.reply || "I apologize, but I couldn't generate a response. Please try again.";
        conversationHistory.push({ role: "assistant", content: aiReply });
        await saveMessage("assistant", aiReply);

        const aiBubble = document.createElement("div");
        aiBubble.className = "bubble ai";
        aiBubble.innerHTML = `
          ${aiReply.replace(/\n/g, '<br>')}
          <button class="listen-btn" onclick="speakText(\`${aiReply.replace(/`/g, '\\`')}\`)">üéß Listen Again</button>
        `;
        chatBox.appendChild(aiBubble);
        chatBox.scrollTop = chatBox.scrollHeight;
        speakText(aiReply);

      } catch (error) {
        hideTypingIndicator();
        console.error('Error:', error);
        
        const errorBubble = document.createElement("div");
        errorBubble.className = "bubble ai";
        errorBubble.innerHTML = `
          ‚ùå Sorry, I'm having trouble connecting. Please check:<br>
          ‚Ä¢ Your internet connection<br>
          ‚Ä¢ If the API is properly configured<br>
          ‚Ä¢ Try again in a moment
        `;
        chatBox.appendChild(errorBubble);
        chatBox.scrollTop = chatBox.scrollHeight;
      } finally {
        sendBtn.disabled = false;
        userInput.disabled = false;
        userInput.focus();
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !sendBtn.disabled) sendMessage();
    });

    function showWelcomeMessage() {
      const welcomeMsg = "Hello! I'm SmartSpeak, your AI English tutor. I'm here to help you improve your English skills through natural conversation. Feel free to ask me questions, practice speaking, or discuss any topic you'd like. How can I help you today?";
      conversationHistory.push({ role: "assistant", content: welcomeMsg });
      
      const aiBubble = document.createElement("div");
      aiBubble.className = "bubble ai";
      aiBubble.innerHTML = `
        ${welcomeMsg}
        <button class="listen-btn" onclick="speakText(\`${welcomeMsg}\`)">üéß Listen Again</button>
      `;
      chatBox.appendChild(aiBubble);
      speakText(welcomeMsg);
    }

    window.speakText = speakText;
    window.startNewConversation = startNewConversation;
    window.loadConversation = loadConversation;
    window.deleteConversation = deleteConversation;
    
    checkAuth();
  </script>
  <!-- Footer -->
  <div class="footer">
    <div class="footer-text">Developed by Heber</div>
  </div>
  
  <!-- Mobile Menu Toggle -->
  <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>

  <!-- PWA Install Script -->
  <script>
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('PWA installable');
    });
    
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
    }
    
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed'));
    }
  </script>
</body>
</body>
</html>
